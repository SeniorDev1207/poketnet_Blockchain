(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[2],{264:function(e,t){},265:function(e,t){},278:function(e,t){},279:function(e,t){},280:function(e,t){},283:function(e,t){},284:function(e,t){},289:function(e,t){},338:function(e,t){},340:function(e,t){},348:function(e,t){},350:function(e,t){},357:function(e,t){},360:function(e,t){},362:function(e,t){},370:function(e,t){},372:function(e,t){},377:function(e,t){},380:function(e,t){},381:function(e,t){},383:function(e,t){},384:function(e,t){},386:function(e,t){},388:function(e,t){},410:function(e,t){},415:function(e,t){},417:function(e,t){},424:function(e,t){},434:function(e,t){},435:function(e,t){},438:function(e,t){},439:function(e,t){},442:function(e,t){},445:function(e,t){},446:function(e,t){},448:function(e,t){},450:function(e,t){},459:function(e,t){},461:function(e,t){},470:function(e,t){},472:function(e,t){},486:function(e,t){},488:function(e,t){},497:function(e,t){},499:function(e,t){},505:function(e,t){},507:function(e,u,h){"use strict";(function(n,a){h.d(u,"a",function(){return o});var l=h(1);var e=h(159);var t=h.n(e);var i=h(508);class r extends i["a"]{constructor(e){super(e);this.version(1).stores({chunks:"id"})}}class s extends i["a"]{constructor(){super("webtorrent-expiration");this.version(1).stores({databases:"name,expiration"})}}class o extends e["EventEmitter"]{constructor(e,t){super();this.pendingPut=[];this.memoryChunks={};this.databaseName="webtorrent-chunks-";if(!t)t={};if(t.torrent&&t.torrent.infoHash)this.databaseName+=t.torrent.infoHash;else this.databaseName+="-default";this.setMaxListeners(100);this.chunkLength=Number(e);if(!this.chunkLength)throw new Error("First argument must be a chunk length");this.length=Number(t.length)||Infinity;if(this.length!==Infinity){this.lastChunkLength=this.length%this.chunkLength||this.chunkLength;this.lastChunkIndex=Math.ceil(this.length/this.chunkLength)-1}this.db=new r(this.databaseName);this.expirationDB=new s;this.runCleaner()}put(e,t,i){const n=e===this.lastChunkIndex;if(n&&t.length!==this.lastChunkLength){return this.nextTick(i,new Error("Last chunk length must be "+this.lastChunkLength))}if(!n&&t.length!==this.chunkLength){return this.nextTick(i,new Error("Chunk length must be "+this.chunkLength))}this.memoryChunks[e]=true;this.pendingPut.push({id:e,buf:t,cb:i});if(this.putBulkTimeout)return;this.putBulkTimeout=setTimeout(()=>Object(l["a"])(this,void 0,void 0,function*(){const t=this.pendingPut;this.pendingPut=[];this.putBulkTimeout=undefined;try{yield this.db.transaction("rw",this.db.chunks,()=>{return this.db.chunks.bulkPut(t.map(e=>({id:e.id,buf:e.buf})))})}catch(e){console.log("Cannot bulk insert chunks. Store them in memory.",{err:e});t.forEach(e=>this.memoryChunks[e.id]=e.buf)}finally{t.forEach(e=>e.cb())}}),o.BUFFERING_PUT_MS)}get(r,s,o){if(typeof s==="function")return this.get(r,null,s);const e=this.memoryChunks[r];if(e===undefined){const t=new Error("Chunk not found");t["notFound"]=true;return n.nextTick(()=>o(t))}if(e!==true)return o(null,e);this.db.transaction("r",this.db.chunks,()=>Object(l["a"])(this,void 0,void 0,function*(){const e=yield this.db.chunks.get({id:r});if(e===undefined)return o(null,a.alloc(0));const t=e.buf;if(!s)return this.nextTick(o,null,t);const i=s.offset||0;const n=s.length||t.length-i;return o(null,t.slice(i,n+i))})).catch(e=>{console.error(e);return o(e)})}close(e){return this.destroy(e)}destroy(t){return Object(l["a"])(this,void 0,void 0,function*(){try{if(this.pendingPut){clearTimeout(this.putBulkTimeout);this.pendingPut=null}if(this.cleanerInterval){clearInterval(this.cleanerInterval);this.cleanerInterval=null}if(this.db){this.db.close();yield this.dropDatabase(this.databaseName)}if(this.expirationDB){this.expirationDB.close();this.expirationDB=null}return t()}catch(e){console.error("Cannot destroy peertube chunk store.",e);return t(e)}})}runCleaner(){this.checkExpiration();this.cleanerInterval=setInterval(()=>Object(l["a"])(this,void 0,void 0,function*(){this.checkExpiration()}),o.CLEANER_INTERVAL_MS)}checkExpiration(){return Object(l["a"])(this,void 0,void 0,function*(){let t=[];try{yield this.expirationDB.transaction("rw",this.expirationDB.databases,()=>Object(l["a"])(this,void 0,void 0,function*(){yield this.expirationDB.databases.put({name:this.databaseName,expiration:(new Date).getTime()+o.CLEANER_EXPIRATION_MS});const e=(new Date).getTime();t=yield this.expirationDB.databases.where("expiration").below(e).toArray()}))}catch(e){console.error("Cannot update expiration of fetch expired databases.",e)}for(const e of t){yield this.dropDatabase(e.name)}})}dropDatabase(t){return Object(l["a"])(this,void 0,void 0,function*(){const e=new r(t);console.log("Destroying IndexDB database %s.",t);try{yield e.delete();yield this.expirationDB.transaction("rw",this.expirationDB.databases,()=>{return this.expirationDB.databases.where({name:t}).delete()})}catch(e){console.error("Cannot delete %s.",t,e)}})}nextTick(e,t,i){n.nextTick(()=>e(t,i),undefined)}}o.BUFFERING_PUT_MS=1e3;o.CLEANER_INTERVAL_MS=1e3*60;o.CLEANER_EXPIRATION_MS=1e3*60*5}).call(this,h(74),h(73).Buffer)},519:function(e,t,i){"use strict";i.r(t);i.d(t,"WebTorrentPlugin",function(){return v});var n=i(0);var r=i.n(n);var s=i(333);var f=i(22);const p=i(213);const y=i(307);const g=[".m4a",".m4v",".mp4"];function o(e,t,i,n){l(e);return a(e,t,i,n)}function a(r,e,t,s){const i=Object(f["extname"])(r.name).toLowerCase();let o;let a=0;let n;try{if(g.indexOf(i)>=0){n=l()}else{n=u()}}catch(e){return s(e)}function l(){d();console.log("useVideostream");o.addEventListener("error",function e(t){o.removeEventListener("error",e);return s(t)});console.log("file",r);o.addEventListener("loadedmetadata",c);return new y(r,o)}function u(e=false){const i=b(r.name,e);console.log("useMediaSource");d();o.addEventListener("error",function e(t){o.removeEventListener("error",e);if(i.indexOf("vp8")!==-1)return h(true);return s(t)});o.addEventListener("loadedmetadata",c);const t=new p(o);const n=t.createWriteStream(i);r.createReadStream().pipe(n);if(a)o.currentTime=a;return t}function h(e=false){if(e===true)console.log("Falling back to media source with VP9 enabled.");else console.log("Falling back to media source..");u(e)}function d(){if(o===undefined){o=e;o.addEventListener("progress",function(){a=e.currentTime})}}function c(){o.removeEventListener("loadedmetadata",c);if(t.autoplay)o.play();s(null,n)}}function l(e){if(e==null){throw new Error("file cannot be null or undefined")}if(typeof e.name!=="string"){throw new Error("missing or invalid file.name property")}if(typeof e.createReadStream!=="function"){throw new Error("missing or invalid file.createReadStream property")}}function b(e,t=false){const i=Object(f["extname"])(e).toLowerCase();if(i===".mp4"){return'video/mp4; codecs="avc1.640029, mp4a.40.5"'}if(i===".webm"){if(t===true)return'video/webm; codecs="vp9, opus"';return'video/webm; codecs="vp8, vorbis"'}return undefined}var u=i(4);var h=i(507);var d=i(10);const c=i(509);const m=r.a.getPlugin("plugin");class v extends m{constructor(e,n){super(e);this.autoplay=false;this.startTime=0;this.CONSTANTS={INFO_SCHEDULER:1e3,AUTO_QUALITY_SCHEDULER:3e3,AUTO_QUALITY_THRESHOLD_PERCENT:30,AUTO_QUALITY_OBSERVATION_TIME:1e4,AUTO_QUALITY_HIGHER_RESOLUTION_DELAY:5e3,BANDWIDTH_AVERAGE_NUMBER_OF_VALUES:5};this.webtorrent=new s({tracker:{rtcConfig:Object(u["d"])()},dht:false});this.destroyingFakeRenderer=false;this.autoResolution=true;this.autoResolutionPossible=true;this.isAutoResolutionObservation=false;this.playerRefusedP2P=false;this.downloadSpeeds=[];this.startTime=Object(u["i"])(n.startTime);this.autoplay=n.autoplay;this.playerRefusedP2P=!Object(d["d"])();this.videoFiles=n.videoFiles;this.videoDuration=n.videoDuration;this.savePlayerSrcFunction=this.player.src;this.playerElement=n.playerElement;this.player.ready(()=>{const e=this.player.options_;const t=Object(d["f"])();if(t!==undefined)this.player.volume(t);const i=e.muted!==undefined?e.muted:Object(d["c"])();if(i!==undefined)this.player.muted(i);this.player.duration(n.videoDuration);this.initializePlayer();this.runTorrentInfoScheduler();this.player.one("play",()=>{this.runAutoQualitySchedulerTimer=setTimeout(()=>this.runAutoQualityScheduler(),this.CONSTANTS.AUTO_QUALITY_SCHEDULER)})})}dispose(){clearTimeout(this.addTorrentDelay);clearTimeout(this.qualityObservationTimer);clearTimeout(this.runAutoQualitySchedulerTimer);clearInterval(this.torrentInfoInterval);clearInterval(this.autoQualityInterval);this.flushVideoFile(this.currentVideoFile,false);this.destroyFakeRenderer()}getCurrentResolutionId(){return this.currentVideoFile?this.currentVideoFile.resolution.id:-1}updateVideoFile(e,t={},i=()=>{}){if(!e){const s=Object(d["a"])();e=s?this.getAppropriateFile(s):this.pickAverageVideoFile()}if(!e){throw Error(`Can't update video file since videoFile is undefined.`)}if(this.currentVideoFile!==undefined&&this.currentVideoFile.magnetUri===e.magnetUri){return}this.disableErrorDisplay();this.player.src=()=>true;const n=this.player.playbackRate();const r=this.currentVideoFile;this.currentVideoFile=e;if(Object(u["e"])()||this.playerRefusedP2P){return this.fallbackToHttp(t,()=>{this.player.playbackRate(n);return i()})}console.log("updateVideoFile");this.addTorrent(this.currentVideoFile.magnetUri,r,t,()=>{this.player.playbackRate(n);return i()});this.changeQuality();this.trigger("resolutionChange",{auto:this.autoResolution,resolutionId:this.currentVideoFile.resolution.id})}updateResolution(t,e=0){const i=this.player.currentTime();const n=this.player.paused();if(!n){this.player.bigPlayButton.hide()}if(t===0){this.player.addClass("vjs-playing-audio-only-content");this.player.posterImage.show()}else{this.player.removeClass("vjs-playing-audio-only-content");this.player.posterImage.hide()}const r=this.videoFiles.find(e=>e.resolution.id===t);const s={forcePlay:false,delay:e,seek:i+e/1e3};this.updateVideoFile(r,s)}flushVideoFile(e,t=true){if(e!==undefined&&this.webtorrent.get(e.magnetUri)){if(t===true&&this.renderer&&this.renderer.destroy)this.renderer.destroy();this.webtorrent.remove(e.magnetUri);console.log("Removed "+e.magnetUri)}}enableAutoResolution(){this.autoResolution=true;this.trigger("resolutionChange",{auto:this.autoResolution,resolutionId:this.getCurrentResolutionId()})}disableAutoResolution(e=false){if(e===true)this.autoResolutionPossible=false;this.autoResolution=false;this.trigger("autoResolutionChange",{possible:this.autoResolutionPossible});this.trigger("resolutionChange",{auto:this.autoResolution,resolutionId:this.getCurrentResolutionId()})}isAutoResolutionPossible(){return this.autoResolutionPossible}getTorrent(){return this.torrent}getCurrentVideoFile(){return this.currentVideoFile}addTorrent(e,n,r,s){if(!e)return this.fallbackToHttp(r,s);console.log("Adding "+e+".");const i=this.torrent;const t={store:function(e,t){return new c(new h["a"](e,t),{max:100})}};this.torrent=this.webtorrent.add(e,t,t=>{console.log("Added "+e+".");if(i){this.stopTorrent(i);if(r.delay)this.renderFileInFakeElement(t.files[0],r.delay)}console.log("options.delay",r.delay);this.addTorrentDelay=setTimeout(()=>{console.log("IMHERENOW");this.destroyFakeRenderer();const i=this.player.paused();this.flushVideoFile(n);if(r.seek)this.player.currentTime(r.seek);const e={autoplay:false,controls:true};o(t.files[0],this.playerElement,e,(e,t)=>{this.renderer=t;if(e)return this.fallbackToHttp(r,s);setTimeout(()=>{return this.tryToPlay(e=>{if(e)return s(e);if(r.seek)this.seek(r.seek);if(r.forcePlay===false&&i===true)this.player.pause();return s()})},10)})},r.delay||0)});this.torrent.on("error",e=>console.error(e));this.torrent.on("warning",e=>{console.log("WARNING",e);if(e.message.indexOf("Unsupported tracker protocol")!==-1)return;if(e.message.indexOf("Ice connection failed")!==-1){console.log(e);return}if(e.message.indexOf("incorrect info hash")!==-1){console.error("Incorrect info hash detected, falling back to torrent file.");const t={forcePlay:true,seek:r.seek};console.log("IM HERE");return this.addTorrent(this.torrent["xs"],n,t,s)}if(e.message.indexOf("from xs param")!==-1){this.handleError(e)}console.warn(e)})}tryToPlay(t){if(!t)t=function(){};const e=this.player.play();if(e!==undefined){return e.then(()=>t()).catch(e=>{if(e.message.indexOf("The play() request")!==-1){return}this.player.pause();this.player.posterImage.show();this.player.removeClass("vjs-has-autoplay");this.player.removeClass("vjs-has-big-play-button-clicked");this.player.removeClass("vjs-playing-audio-only-content");return t()})}return t()}seek(e){this.player.currentTime(e);this.player.handleTechSeeked_()}getAppropriateFile(n){if(this.videoFiles===undefined)return undefined;const t=this.videoFiles.filter(e=>e.resolution.id!==0);if(t.length===0)return undefined;if(t.length===1)return t[0];if(this.torrent&&this.torrent.progress===1&&this.player.ended())return this.currentVideoFile;if(!n)n=this.getAndSaveActualDownloadSpeed();const i=this.playerElement.offsetHeight;let r=t[0].resolution.id;for(let e=t.length-1;e>=0;e--){const s=t[e].resolution.id;if(s!==0&&s>=i){r=s;break}}const e=t.filter(e=>e.resolution.id<=r).filter(e=>{const t=e.size/this.videoDuration;let i=t;if(!this.currentVideoFile||e.resolution.id>this.currentVideoFile.resolution.id){i+=t*this.CONSTANTS.AUTO_QUALITY_THRESHOLD_PERCENT/100}return n>i});if(e.length===0)return Object(u["l"])(t);return Object(u["k"])(e)}getAndSaveActualDownloadSpeed(){const e=Math.max(this.downloadSpeeds.length-this.CONSTANTS.BANDWIDTH_AVERAGE_NUMBER_OF_VALUES,0);const t=this.downloadSpeeds.slice(e,this.downloadSpeeds.length);if(t.length===0)return-1;const i=t.reduce((e,t)=>e+t);const n=Math.round(i/t.length);Object(d["g"])(n);return n}initializePlayer(){this.buildQualities();if(this.autoplay){this.player.posterImage.hide();return this.updateVideoFile(undefined,{forcePlay:true,seek:this.startTime})}const e=this.player.play.bind(this.player);this.player.play=()=>{this.player.addClass("vjs-has-big-play-button-clicked");this.player.play=e;this.updateVideoFile(undefined,{forcePlay:true,seek:this.startTime})}}runAutoQualityScheduler(){this.autoQualityInterval=setInterval(()=>{if(this.torrent===undefined||this.torrent===null)return;if(this.autoResolution===false)return;if(this.isAutoResolutionObservation===true)return;const e=this.getAppropriateFile();let t=false;let i=0;if(this.isPlayerWaiting()&&e.resolution.id<this.currentVideoFile.resolution.id){console.log("Downgrading automatically the resolution to: %s",e.resolution.label);t=true}else if(e.resolution.id>this.currentVideoFile.resolution.id){console.log("Upgrading automatically the resolution to: %s",e.resolution.label);t=true;i=this.CONSTANTS.AUTO_QUALITY_HIGHER_RESOLUTION_DELAY}if(t===true){this.updateResolution(e.resolution.id,i);this.isAutoResolutionObservation=true;this.qualityObservationTimer=setTimeout(()=>{this.isAutoResolutionObservation=false},this.CONSTANTS.AUTO_QUALITY_OBSERVATION_TIME)}},this.CONSTANTS.AUTO_QUALITY_SCHEDULER)}isPlayerWaiting(){return this.player&&this.player.hasClass("vjs-waiting")}runTorrentInfoScheduler(){this.torrentInfoInterval=setInterval(()=>{if(this.torrent===undefined)return;if(this.torrent===null)return this.player.trigger("p2pInfo",false);if(this.webtorrent.downloadSpeed!==0)this.downloadSpeeds.push(this.webtorrent.downloadSpeed);return this.player.trigger("p2pInfo",{source:"webtorrent",http:{downloadSpeed:0,uploadSpeed:0,downloaded:0,uploaded:0},p2p:{downloadSpeed:this.torrent.downloadSpeed,numPeers:this.torrent.numPeers,uploadSpeed:this.torrent.uploadSpeed,downloaded:this.torrent.downloaded,uploaded:this.torrent.uploaded}})},this.CONSTANTS.INFO_SCHEDULER)}fallbackToHttp(t,i){const n=this.player.paused();this.disableAutoResolution(true);this.flushVideoFile(this.currentVideoFile,true);this.torrent=null;this.player.one("error",()=>this.enableErrorDisplay());const e=this.currentVideoFile.fileUrl;this.player.src=this.savePlayerSrcFunction;this.player.src(e);this.changeQuality();this.player.trigger("sourcechange");return this.tryToPlay(e=>{console.log("TRYTOPLAYDONE",e,t);if(e&&i)return i(e);if(t.seek)this.seek(t.seek);if(t.forcePlay===false&&n===true)this.player.pause();if(i)return i()})}handleError(e){return this.player.trigger("customError",{err:e})}enableErrorDisplay(){this.player.addClass("vjs-error-display-enabled")}disableErrorDisplay(){this.player.removeClass("vjs-error-display-enabled")}pickAverageVideoFile(){if(this.videoFiles.length===1)return this.videoFiles[0];return this.videoFiles[Math.floor(this.videoFiles.length/2)]}stopTorrent(e){e.pause();e.removePeer(e["ws"])}renderFileInFakeElement(e,i){this.destroyingFakeRenderer=false;const n=document.createElement("video");o(e,n,{autoplay:false,controls:false},(e,t)=>{this.fakeRenderer=t;if(this.destroyingFakeRenderer===false&&e){console.error("Cannot render new torrent in fake video element.",e)}n.currentTime=this.player.currentTime()+(i-2e3)})}destroyFakeRenderer(){if(this.fakeRenderer){this.destroyingFakeRenderer=true;if(this.fakeRenderer.destroy){try{this.fakeRenderer.destroy()}catch(e){console.log("Cannot destroy correctly fake renderer.",e)}}this.fakeRenderer=undefined}}buildQualities(){const e=[];for(const i of this.videoFiles){const n={id:i.resolution.id,label:this.buildQualityLabel(i),height:i.resolution.id,_enabled:true};this.player.qualityLevels().addQualityLevel(n);e.push({id:n.id,label:n.label,selected:false})}const t={qualitySwitchCallback:e=>this.qualitySwitchCallback(e),qualityData:{video:e}};this.player.tech(true).trigger("loadedqualitydata",t)}buildQualityLabel(e){let t=e.resolution.label;if(e.fps&&e.fps>=50){t+=e.fps}return t}qualitySwitchCallback(e){if(e===-1){if(this.autoResolutionPossible===true)this.enableAutoResolution();return}this.disableAutoResolution();this.updateResolution(e)}changeQuality(){const t=this.currentVideoFile.resolution.id;const i=this.player.qualityLevels();if(t===-1){i.selectedIndex=-1;return}for(let e=0;e<i.length;e++){const n=i[e];if(n.height===t)i.selectedIndex_=e}}}r.a.registerPlugin("webtorrent",v)}}]);