<% 

var name = function(address){
	return deep(app, 'platform.sdk.usersl.storage.'+address+'.name') || address 
}

var image = function(address){
	var src = deep(app, 'platform.sdk.usersl.storage.'+address+'.image') %>

	<div class="icon">
		<div class="usericon" image="<%-src || ''%>">
			<% if(!src) {%>
				<svg width="30" height="30" data-jdenticon-value="<%-address%>"></svg>
			<% } %>
		</div>
	</div>
<% }

_.each(chats, function(chat){ 

	var users = _.filter(chat.users || [], function(u){
		return user.address.value != u
	})

	var usersNames = [];

	_.each(users, function(u, i) {
		if((i > 2 && users.length > 4) || i > 3) return

		usersNames.push(name(u))
	})

	var messages = [];

	var count = Math.min(users.length, 5)

%> 

	<div class="chat table" chat="<%-chat.id%>">
		<div class="chatImageWrapper">
			<div class="chatImageRound" count="<%-count%>">

				<% _.each(users, function(u, i) { 

					if((i > 2 && users.length > 4) || i > 3) return

				%>

					<div class="userIconWrapper">
						<% image(u) %>
					</div>

				<% }) %>

			</div>
		</div>

		<div class="chatBody">

			<div class="chatHeader">

				<%- usersNames.join(',') %>

				<% var c = (users.length - usersNames.length) %>

				<% if (c > 0) {%>

					and more <%- c %> users

				<% } %>

			</div>

			<div class="chatContent">
				<div class="chatContentTable table">
					<div class="chatMessages">

						<% if(!messages.length) {%>

							<div class="cempty">
								You haven't messages in this chat
							</div>

						<% } %>

					</div>

					<div class="newMessages">
						
					</div>
				</div>
			</div>

		</div>

		<div class="chatpanel">
		</div>
	</div>

<% }) %>